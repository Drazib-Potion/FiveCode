// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum VariantLevel {
  FIRST
  SECOND
}

enum Role {
  CONSULTATION
  MANAGER
  ADMIN
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  role      Role     @default(ADMIN)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model ProductType {
  id        String   @id @default(uuid())
  name       String
  code       String   @unique // Code du type de produit (ex: "A", "B")
  createdAt  DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("product_types")
}

model Family {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variants                        Variant[]
  technicalCharacteristicFamilies TechnicalCharacteristicFamily[]
  products                        Product[]

  @@map("families")
}

model Variant {
  id        String   @id @default(uuid())
  familyId  String
  name      String
  code      String // Code de la variante (ex: "1")
  variantLevel VariantLevel @default(FIRST)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  family                           Family                          @relation(fields: [familyId], references: [id], onDelete: Cascade)
  technicalCharacteristicVariants TechnicalCharacteristicVariant[]
  generatedInfosAsVariant1         ProductGeneratedInfo[] @relation("Variant1Infos")
  generatedInfosAsVariant2         ProductGeneratedInfo[] @relation("Variant2Infos")

  @@unique([familyId, code, variantLevel]) // Permet d'avoir des codes identiques pour variantes 1 et 2
  @@map("variants")
}

model TechnicalCharacteristic {
  id           String   @id @default(uuid())
  name         String
  type         String // "string" | "number" | "boolean" | "enum"
  enumOptions  Json?    // Tableau de strings pour les options enum
  enumMultiple Boolean? @default(false) // true = sélection multiple, false = sélection unique
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  families        TechnicalCharacteristicFamily[]
  variants        TechnicalCharacteristicVariant[]
  generatedInfos  ProductTechnicalCharacteristic[] // Via ProductGeneratedInfo

  @@map("technical_characteristics")
}

model Product {
  id            String   @id @default(uuid())
  name          String
  code          String   @unique // Code du produit défini par l'utilisateur
  familyId      String
  productTypeId String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  family         Family                 @relation(fields: [familyId], references: [id], onDelete: Cascade)
  productType    ProductType            @relation(fields: [productTypeId], references: [id], onDelete: Cascade)
  generatedInfos ProductGeneratedInfo[] // Un produit peut avoir plusieurs infos générées

  @@map("products")
}

// Informations générées (code généré + variante + champs)
model ProductGeneratedInfo {
  id            String   @id @default(uuid())
  productId     String
  variant1Id    String?
  variant2Id    String?
  generatedCode String   @unique // Le code généré unique
  createdBy     String?   // Email de l'utilisateur qui a créé le code
  updatedBy     String? // Email de l'utilisateur qui a modifié le code
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt // Utilisé comme lastModifiedDate

  product                  Product                          @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant1                 Variant?                         @relation("Variant1Infos", fields: [variant1Id], references: [id], onDelete: Cascade)
  variant2                 Variant?                         @relation("Variant2Infos", fields: [variant2Id], references: [id], onDelete: Cascade)
  technicalCharacteristics ProductTechnicalCharacteristic[] // Caractéristiques techniques avec valeurs de cette info générée

  @@map("product_generated_infos")
}


// Table d'exclusions entre variantes
// Table de liaison pour ProductGeneratedInfo <-> TechnicalCharacteristic avec valeurs
model ProductTechnicalCharacteristic {
  id                        String   @id @default(uuid())
  generatedInfoId           String // Pointe vers ProductGeneratedInfo au lieu de Product
  technicalCharacteristicId String
  value                     String
  createdAt                 DateTime @default(now())

  generatedInfo           ProductGeneratedInfo    @relation(fields: [generatedInfoId], references: [id], onDelete: Cascade)
  technicalCharacteristic TechnicalCharacteristic @relation(fields: [technicalCharacteristicId], references: [id], onDelete: Cascade)

  @@unique([generatedInfoId, technicalCharacteristicId])
  @@map("product_technical_characteristics")
}

// Table de liaison pour TechnicalCharacteristic <-> Family (many-to-many)
model TechnicalCharacteristicFamily {
  id                        String   @id @default(uuid())
  technicalCharacteristicId String
  familyId                  String
  createdAt                 DateTime @default(now())

  technicalCharacteristic TechnicalCharacteristic @relation(fields: [technicalCharacteristicId], references: [id], onDelete: Cascade)
  family                   Family                 @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([technicalCharacteristicId, familyId])
  @@map("technical_characteristic_families")
}

// Table de liaison pour TechnicalCharacteristic <-> Variant (many-to-many)
model TechnicalCharacteristicVariant {
  id                        String   @id @default(uuid())
  technicalCharacteristicId String
  variantId                 String
  createdAt                 DateTime @default(now())

  technicalCharacteristic TechnicalCharacteristic @relation(fields: [technicalCharacteristicId], references: [id], onDelete: Cascade)
  variant                  Variant                 @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@unique([technicalCharacteristicId, variantId])
  @@map("technical_characteristic_variants")
}